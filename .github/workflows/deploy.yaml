name: Laravel CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Server via SSH
    runs-on: ubuntu-22.04
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.EC2_SSH_PEM }}
          port: ${{ secrets.SSH_PORT }}
          source: "./${{ vars.DEPLOY_FOLDER }}/*"
          target: "${{ vars.DEPLOY_BASE_PATH }}"

      - name: Upload .env from variable
        uses: appleboy/ssh-action@v1.2.1
        env:
          BASE_PATH: /var/www/html
          FOLDER: biblioteca
          CONFIG_FOLDER: biblioteca.config
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.EC2_SSH_PEM }}
          port: ${{ secrets.SSH_PORT }}
          script: |
                  base_path=$BASE_PATH
                  folder=$FOLDER
                  config_folder=$CONFIG_FOLDER
                  echo "${base_path}/${config_folder}/.env.production"
                  echo "${base_path}/${folder}/.env"
                  cp "${base_path}/${config_folder}/.env.production" "${base_path}/${folder}/.env"


      - name: Run remote commands
        uses: appleboy/ssh-action@v1.2.1
        env:
            BASE_PATH: /var/www/html
            FOLDER: biblioteca
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.EC2_SSH_PEM }}
          port: ${{ secrets.SSH_PORT }}
          script: |
                  base_path=$BASE_PATH
                  folder=$FOLDER

                  cd "$base_path/$folder"

                  composer install --no-interaction --prefer-dist --optimize-autoloader
                  php artisan migrate --force
                  php artisan config:cache
                  php artisan route:cache
                  php artisan view:cache
                  nohup php artisan serve --port 8080 > /dev/null 2>&1 & disown
                  sudo systemctl restart nginx
