name: Laravel CI/CD

on:
  push:
    branches: [develop]


jobs:
  deploy:
    name: Deploy to Server via SSH
    runs-on: ubuntu-22.04
    environment: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: backup files
        uses: appleboy/ssh-action@v1.2.1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.EC2_SSH_PEM }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            rm -f ${{ vars.DEPLOY_BASE_PATH }}/${{ vars.DEPLOY_FOLDER }}_bkp2.zip 2>/dev/null || true
            mv -f ${{ vars.DEPLOY_BASE_PATH }}/${{ vars.DEPLOY_FOLDER }}_bkp.zip ${{ vars.DEPLOY_BASE_PATH }}/${{ vars.DEPLOY_FOLDER }}_bkp2.zip 2>/dev/null || true
            zip -r -q ${{ vars.DEPLOY_BASE_PATH }}/${{ vars.DEPLOY_FOLDER }}_bkp.zip ${{ vars.DEPLOY_BASE_PATH }}/${{ vars.DEPLOY_FOLDER }} || true

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.EC2_SSH_PEM }}
          port: ${{ secrets.SSH_PORT }}
          source: "./biblioteca/*"
          target: "${{ vars.DEPLOY_BASE_PATH }}/${{ vars.DEPLOY_FOLDER }}"

      - name: Upload .env from variable
        uses: appleboy/ssh-action@v1.2.1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.EC2_SSH_PEM }}
          port: ${{ secrets.SSH_PORT }}
          script: |
                  base_path=${{ vars.DEPLOY_BASE_PATH }}
                  folder=${{ vars.DEPLOY_FOLDER }}
                  config_folder=${{ vars.ENV_FOLDER }}
                  echo "${base_path}/${config_folder}/.env"
                  echo "${base_path}/${folder}/.env"
                  cp -r "${base_path}/${config_folder}/.env" "${base_path}/${folder}/biblioteca/.env"


      - name: Run remote commands
        uses: appleboy/ssh-action@v1.2.1
        env:
            BASE_PATH: /var/www/html
            FOLDER: biblioteca
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.EC2_SSH_PEM }}
          port: ${{ secrets.SSH_PORT }}
          script: |
                  base_path=${{ vars.DEPLOY_BASE_PATH }}
                  folder=${{ vars.DEPLOY_FOLDER }}
                  echo "$base_path/$folder/biblioteca"
                  cd "$base_path/$folder/biblioteca"

                  composer install --no-interaction --prefer-dist --optimize-autoloader
                  php artisan migrate --force
                  php artisan config:clear
                  php artisan route:clear
                  php artisan view:clear
                  php artisan cache:clear
                  php artisan config:cache
                  php artisan route:cache
                  php artisan view:cache
                  sudo systemctl restart nginx